import * as z from "zod/v4";
import type { Severity } from "@/entities/vulnerability/model/types";

/**
 * OSV API 응답의 취약점 스키마
 */
export const osvVulnerabilitySchema = z.object({
  id: z.string(),
  summary: z.string().optional(),
  details: z.string().optional(),
  severity: z.array(z.object({
    type: z.string(),
    score: z.string().optional(),
  })).optional(),
  affected: z.array(z.object({
    package: z.object({
      name: z.string(),
      ecosystem: z.string(),
    }),
    ranges: z.array(z.object({
      type: z.string(),
      events: z.array(z.object({
        introduced: z.string().optional(),
        fixed: z.string().optional(),
      })),
    })).optional(),
    versions: z.array(z.string()).optional(),
  })).optional(),
  references: z.array(z.object({
    type: z.string(),
    url: z.string(),
  })).optional(),
});

export type OSVVulnerability = z.infer<typeof osvVulnerabilitySchema>;

/**
 * OSV API 응답 스키마
 */
export const osvResponseSchema = z.object({
  vulns: z.array(osvVulnerabilitySchema).optional().default([]),
});

export type OSVResponse = z.infer<typeof osvResponseSchema>;

/**
 * CVSS 점수를 Severity로 변환
 */
export function cvssToSeverity(cvssScore: number): Severity {
  if (cvssScore >= 9.0) return "critical";
  if (cvssScore >= 7.0) return "high";
  if (cvssScore >= 4.0) return "medium";
  return "low";
}

/**
 * OSV severity 타입을 Severity로 변환
 */
export function osvSeverityToSeverity(osvSeverity: string | undefined): Severity {
  if (!osvSeverity) return "medium"; // 기본값
  
  const score = parseFloat(osvSeverity);
  if (!isNaN(score)) {
    return cvssToSeverity(score);
  }
  
  // 문자열 기반 매핑
  const normalized = osvSeverity.toLowerCase();
  if (normalized.includes("critical")) return "critical";
  if (normalized.includes("high")) return "high";
  if (normalized.includes("medium") || normalized.includes("moderate")) return "medium";
  if (normalized.includes("low")) return "low";
  
  return "medium";
}
