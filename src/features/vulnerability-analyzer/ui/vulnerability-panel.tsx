"use client";

import { useMemo } from "react";
import type { PackageVulnerability, SeverityWithSafe } from "@/entities/vulnerability/model/types";

interface VulnerabilityPanelProps {
  packages: PackageVulnerability[];
  onPackageHover?: (packageName: string | null) => void;
  onPackageClick?: (packageName: string) => void;
  highlightedPackage?: string | null;
}

/**
 * 심각도별 색상
 */
const SEVERITY_COLORS: Record<SeverityWithSafe, string> = {
  critical: "#E74C3C",
  high: "#F39C12",
  medium: "#F1C40F",
  low: "#2ECC71",
  safe: "#BFC2C7",
};

/**
 * 심각도 라벨
 */
const SEVERITY_LABELS: Record<SeverityWithSafe, string> = {
  critical: "Critical",
  high: "High",
  medium: "Medium",
  low: "Low",
  safe: "Safe",
};

/**
 * 취약점 패널 컴포넌트
 * 오른쪽 사이드바에 취약점 목록 표시
 */
export function VulnerabilityPanel({
  packages,
  onPackageHover,
  onPackageClick,
  highlightedPackage,
}: VulnerabilityPanelProps) {
  // 취약점이 있는 패키지만 필터링 및 심각도 순 정렬
  const vulnerablePackages = useMemo(() => {
    const severityOrder = ["critical", "high", "medium", "low", "safe"];
    return [...packages]
      .filter((pkg) => pkg.maxSeverity !== "safe")
      .sort((a, b) => {
        return severityOrder.indexOf(a.maxSeverity) - severityOrder.indexOf(b.maxSeverity);
      });
  }, [packages]);

  // 심각도별 카운트
  const severityCounts = useMemo(() => {
    const counts = { critical: 0, high: 0, medium: 0, low: 0 };
    vulnerablePackages.forEach((pkg) => {
      const severity = pkg.maxSeverity as keyof typeof counts;
      if (severity in counts) {
        counts[severity]++;
      }
    });
    return counts;
  }, [vulnerablePackages]);

  const totalVulnerabilities = vulnerablePackages.reduce(
    (sum, pkg) => sum + pkg.vulnerabilities.length,
    0
  );

  return (
    <div className="h-full flex flex-col bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      {/* 헤더 */}
      <div className="p-4 border-b border-gray-100">
        <h2 className="text-lg font-semibold text-gray-800">Vulnerabilities</h2>
        <p className="text-sm text-gray-500 mt-1">
          {vulnerablePackages.length} packages · {totalVulnerabilities} vulnerabilities
        </p>
        
        {/* 심각도 배지 */}
        <div className="flex gap-2 mt-3">
          {Object.entries(severityCounts).map(([severity, count]) => (
            count > 0 && (
              <div
                key={severity}
                className="flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium"
                style={{
                  backgroundColor: `${SEVERITY_COLORS[severity as SeverityWithSafe]}20`,
                  color: SEVERITY_COLORS[severity as SeverityWithSafe],
                }}
              >
                <span
                  className="w-2 h-2 rounded-full"
                  style={{ backgroundColor: SEVERITY_COLORS[severity as SeverityWithSafe] }}
                />
                {count} {SEVERITY_LABELS[severity as SeverityWithSafe]}
              </div>
            )
          ))}
        </div>
      </div>

      {/* 패키지 리스트 */}
      <div className="flex-1 overflow-y-auto p-2">
        {vulnerablePackages.length === 0 ? (
          <div className="flex items-center justify-center h-full text-gray-400">
            <p>No vulnerabilities found ✓</p>
          </div>
        ) : (
          <div className="space-y-2">
            {vulnerablePackages.map((pkg) => (
              <div
                key={pkg.packageName}
                className={`p-3 rounded-lg border transition-all cursor-pointer ${
                  highlightedPackage === pkg.packageName
                    ? "bg-gray-100 border-gray-300 shadow-sm"
                    : "bg-white border-gray-100 hover:border-gray-200 hover:shadow-sm"
                }`}
                onMouseEnter={() => onPackageHover?.(pkg.packageName)}
                onMouseLeave={() => onPackageHover?.(null)}
                onClick={() => onPackageClick?.(pkg.packageName)}
              >
                <div className="flex items-start gap-3">
                  {/* 심각도 인디케이터 */}
                  <span
                    className="w-3 h-3 rounded-full mt-1 flex-shrink-0"
                    style={{ backgroundColor: SEVERITY_COLORS[pkg.maxSeverity] }}
                  />
                  
                  {/* 패키지 정보 */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-baseline gap-2">
                      <span className="font-medium text-gray-800 truncate">
                        {pkg.packageName}
                      </span>
                      <span className="text-xs text-gray-400 flex-shrink-0">
                        {pkg.version}
                      </span>
                    </div>
                    
                    <div className="flex items-center gap-2 mt-1">
                      <span
                        className="text-xs font-medium px-1.5 py-0.5 rounded"
                        style={{
                          backgroundColor: `${SEVERITY_COLORS[pkg.maxSeverity]}15`,
                          color: SEVERITY_COLORS[pkg.maxSeverity],
                        }}
                      >
                        {SEVERITY_LABELS[pkg.maxSeverity]}
                      </span>
                      <span className="text-xs text-gray-400">
                        {pkg.vulnerabilities.length} vulnerabilities
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
