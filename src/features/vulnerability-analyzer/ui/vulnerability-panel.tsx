"use client";

import { useMemo, useState } from "react";
import type { PackageVulnerability, SeverityWithSafe } from "@/entities/vulnerability/model/types";

interface VulnerabilityPanelProps {
  packages: PackageVulnerability[];
  onPackageHover?: (packageName: string | null) => void;
  onPackageClick?: (packageName: string) => void;
  highlightedPackage?: string | null;
}

/**
 * 심각도별 색상
 */
const SEVERITY_COLORS: Record<SeverityWithSafe, string> = {
  critical: "#E74C3C",
  high: "#F39C12",
  medium: "#F1C40F",
  low: "#2ECC71",
  safe: "#BFC2C7",
};

/**
 * 심각도 라벨
 */
const SEVERITY_LABELS: Record<SeverityWithSafe, string> = {
  critical: "Critical",
  high: "High",
  medium: "Medium",
  low: "Low",
  safe: "Safe",
};

/**
 * 심각도 순서
 */
const SEVERITY_ORDER: SeverityWithSafe[] = ["critical", "high", "medium", "low", "safe"];

interface TooltipState {
  visible: boolean;
  x: number;
  y: number;
  pkg: PackageVulnerability | null;
}

/**
 * 취약점 패널 컴포넌트
 * 오른쪽 사이드바에 취약점 목록 표시
 * - 모든 패키지 (취약 + safe) 심각도별 그룹으로 표시
 * - 호버 시 툴팁 표시
 */
export function VulnerabilityPanel({
  packages,
  onPackageHover,
  onPackageClick,
  highlightedPackage,
}: VulnerabilityPanelProps) {
  const [tooltip, setTooltip] = useState<TooltipState>({
    visible: false,
    x: 0,
    y: 0,
    pkg: null,
  });

  // 심각도별로 패키지 그룹화
  const groupedPackages = useMemo(() => {
    const groups: Record<SeverityWithSafe, PackageVulnerability[]> = {
      critical: [],
      high: [],
      medium: [],
      low: [],
      safe: [],
    };
    
    packages.forEach((pkg) => {
      groups[pkg.maxSeverity].push(pkg);
    });
    
    return groups;
  }, [packages]);

  // 심각도별 카운트
  const severityCounts = useMemo(() => {
    const counts: Record<SeverityWithSafe, number> = {
      critical: 0,
      high: 0,
      medium: 0,
      low: 0,
      safe: 0,
    };
    packages.forEach((pkg) => {
      counts[pkg.maxSeverity]++;
    });
    return counts;
  }, [packages]);

  const totalVulnerabilities = packages.reduce(
    (sum, pkg) => sum + pkg.vulnerabilities.length,
    0
  );

  const handleMouseMove = (e: React.MouseEvent, pkg: PackageVulnerability) => {
    setTooltip({
      visible: true,
      x: e.clientX + 10,
      y: e.clientY + 10,
      pkg,
    });
    onPackageHover?.(pkg.packageName);
  };

  const handleMouseLeave = () => {
    setTooltip({ visible: false, x: 0, y: 0, pkg: null });
    onPackageHover?.(null);
  };

  return (
    <div className="h-full flex flex-col bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200 shadow-sm overflow-hidden relative">
      {/* 헤더 */}
      <div className="p-4 border-b border-gray-100">
        <h2 className="text-lg font-semibold text-gray-800">Dependencies</h2>
        <p className="text-sm text-gray-500 mt-1">
          {packages.length} packages · {totalVulnerabilities} vulnerabilities
        </p>
        
        {/* 심각도 배지 */}
        <div className="flex flex-wrap gap-2 mt-3">
          {SEVERITY_ORDER.map((severity) => (
            severityCounts[severity] > 0 && (
              <div
                key={severity}
                className="flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium"
                style={{
                  backgroundColor: `${SEVERITY_COLORS[severity]}20`,
                  color: SEVERITY_COLORS[severity],
                }}
              >
                <span
                  className="w-2 h-2 rounded-full"
                  style={{ backgroundColor: SEVERITY_COLORS[severity] }}
                />
                {severityCounts[severity]} {SEVERITY_LABELS[severity]}
              </div>
            )
          ))}
        </div>
      </div>

      {/* 패키지 리스트 - 심각도별 그룹 */}
      <div className="flex-1 overflow-y-auto p-2">
        {packages.length === 0 ? (
          <div className="flex items-center justify-center h-full text-gray-400">
            <p>No packages found</p>
          </div>
        ) : (
          <div className="space-y-4">
            {SEVERITY_ORDER.map((severity) => {
              const pkgList = groupedPackages[severity];
              if (pkgList.length === 0) return null;
              
              return (
                <div key={severity}>
                  {/* 그룹 헤더 */}
                  <div 
                    className="flex items-center gap-2 px-2 py-1 text-xs font-medium uppercase tracking-wide"
                    style={{ color: SEVERITY_COLORS[severity] }}
                  >
                    <span
                      className="w-2 h-2 rounded-full"
                      style={{ backgroundColor: SEVERITY_COLORS[severity] }}
                    />
                    {SEVERITY_LABELS[severity]} ({pkgList.length})
                  </div>
                  
                  {/* 패키지 목록 */}
                  <div className="space-y-1 mt-1">
                    {pkgList.map((pkg) => (
                      <div
                        key={pkg.packageName}
                        className={`p-2 rounded-lg border transition-all cursor-pointer ${
                          highlightedPackage === pkg.packageName
                            ? "bg-gray-100 border-gray-300 shadow-sm"
                            : "bg-white border-gray-100 hover:border-gray-200 hover:shadow-sm"
                        }`}
                        onMouseMove={(e) => handleMouseMove(e, pkg)}
                        onMouseLeave={handleMouseLeave}
                        onClick={() => onPackageClick?.(pkg.packageName)}
                      >
                        <div className="flex items-center gap-2">
                          {/* 심각도 인디케이터 */}
                          <span
                            className="w-2 h-2 rounded-full flex-shrink-0"
                            style={{ backgroundColor: SEVERITY_COLORS[pkg.maxSeverity] }}
                          />
                          
                          {/* 패키지 정보 */}
                          <span className="font-medium text-sm text-gray-800 truncate flex-1">
                            {pkg.packageName}
                          </span>
                          <span className="text-xs text-gray-400 flex-shrink-0">
                            {pkg.version}
                          </span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* 툴팁 (마우스 따라다님) */}
      {tooltip.visible && tooltip.pkg && (
        <div
          className="fixed z-50 pointer-events-none"
          style={{
            left: tooltip.x,
            top: tooltip.y,
          }}
        >
          <div className="bg-gray-900/95 backdrop-blur-sm text-white rounded-lg px-3 py-2 shadow-xl max-w-xs">
            <div className="font-medium text-sm">{tooltip.pkg.packageName}</div>
            <div className="text-xs text-gray-300 mt-0.5">
              v{tooltip.pkg.version}
            </div>
            
            {tooltip.pkg.vulnerabilities.length > 0 ? (
              <div className="mt-2 text-xs">
                <div className="text-red-400 font-medium">
                  {tooltip.pkg.vulnerabilities.length} vulnerabilities
                </div>
                <ul className="mt-1 space-y-0.5">
                  {tooltip.pkg.vulnerabilities.slice(0, 3).map((vuln) => (
                    <li key={vuln.id} className="text-gray-300 truncate">
                      • {vuln.title || vuln.id}
                    </li>
                  ))}
                  {tooltip.pkg.vulnerabilities.length > 3 && (
                    <li className="text-gray-400">
                      +{tooltip.pkg.vulnerabilities.length - 3} more...
                    </li>
                  )}
                </ul>
              </div>
            ) : (
              <div className="mt-1 text-xs text-green-400">
                ✓ No known vulnerabilities
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
