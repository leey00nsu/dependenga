"use client";

import type {
    VulnerabilityAnalysisResult,
    PackageVulnerability,
    Vulnerability,
    SeverityWithSafe,
} from "@/entities/vulnerability/model/types";
import { Card, CardContent, CardHeader, CardTitle } from "@/shared/ui/card";
import { useState } from "react";

/**
 * ì‹¬ê°ë„ë³„ ìŠ¤íƒ€ì¼
 */
const SEVERITY_STYLES: Record<SeverityWithSafe, { bg: string; text: string; border: string }> = {
  critical: { bg: "bg-red-500/10", text: "text-red-600", border: "border-red-500" },
  high: { bg: "bg-orange-500/10", text: "text-orange-600", border: "border-orange-500" },
  medium: { bg: "bg-yellow-500/10", text: "text-yellow-600", border: "border-yellow-500" },
  low: { bg: "bg-lime-500/10", text: "text-lime-600", border: "border-lime-500" },
  safe: { bg: "bg-green-500/10", text: "text-green-600", border: "border-green-500" },
};

/**
 * ì‹¬ê°ë„ ë°°ì§€ ì»´í¬ë„ŒíŠ¸
 */
function SeverityBadge({ severity }: { severity: SeverityWithSafe }) {
  const style = SEVERITY_STYLES[severity];
  return (
    <span
      className={`px-2 py-0.5 rounded-full text-xs font-medium uppercase ${style.bg} ${style.text}`}
    >
      {severity}
    </span>
  );
}

/**
 * ì·¨ì•½ì  ìƒì„¸ ì •ë³´
 */
function VulnerabilityDetail({ vuln }: { vuln: Vulnerability }) {
  return (
    <div className="py-2 border-b border-border last:border-0">
      <div className="flex items-center gap-2 mb-1">
        <SeverityBadge severity={vuln.severity} />
        <span className="font-mono text-xs text-muted-foreground">{vuln.id}</span>
      </div>
      <p className="text-sm font-medium">{vuln.title}</p>
      {vuln.description && (
        <p className="text-xs text-muted-foreground mt-1 line-clamp-2">{vuln.description}</p>
      )}
      <div className="flex gap-4 mt-2 text-xs text-muted-foreground">
        <span>ì˜í–¥: {vuln.affectedVersions}</span>
        {vuln.fixedVersion && <span>ìˆ˜ì •: {vuln.fixedVersion}</span>}
      </div>
    </div>
  );
}

/**
 * íŒ¨í‚¤ì§€ë³„ ì·¨ì•½ì  ì¹´ë“œ
 */
function PackageVulnerabilityCard({ pkg }: { pkg: PackageVulnerability }) {
  const [expanded, setExpanded] = useState(false);
  const style = SEVERITY_STYLES[pkg.maxSeverity];
  const hasVulns = pkg.vulnerabilities.length > 0;

  const handleToggle = () => {
    if (hasVulns) setExpanded(!expanded);
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      handleToggle();
    }
  };

  return (
    <div
      role={hasVulns ? "button" : undefined}
      tabIndex={hasVulns ? 0 : undefined}
      className={`p-3 rounded-lg border-l-4 ${style.border} ${style.bg} ${hasVulns ? "cursor-pointer" : ""} transition-all hover:shadow-md`}
      onClick={handleToggle}
      onKeyDown={hasVulns ? handleKeyDown : undefined}
      aria-expanded={hasVulns ? expanded : undefined}
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <span className="font-medium">{pkg.packageName}</span>
          <span className="text-xs text-muted-foreground font-mono">{pkg.version}</span>
        </div>
        <div className="flex items-center gap-2">
          {hasVulns && (
            <span className="text-xs text-muted-foreground">
              {pkg.vulnerabilities.length}ê°œ ì·¨ì•½ì 
            </span>
          )}
          <SeverityBadge severity={pkg.maxSeverity} />
        </div>
      </div>

      {expanded && hasVulns && (
        <div className="mt-3 bg-background rounded-md p-2">
          {pkg.vulnerabilities.map((vuln) => (
            <VulnerabilityDetail key={vuln.id} vuln={vuln} />
          ))}
        </div>
      )}
    </div>
  );
}

/**
 * ìš”ì•½ í†µê³„ ì»´í¬ë„ŒíŠ¸
 */
function SummaryStats({ result }: { result: VulnerabilityAnalysisResult }) {
  const stats = [
    { label: "Critical", count: result.summary.critical, severity: "critical" as const },
    { label: "High", count: result.summary.high, severity: "high" as const },
    { label: "Medium", count: result.summary.medium, severity: "medium" as const },
    { label: "Low", count: result.summary.low, severity: "low" as const },
    { label: "Safe", count: result.summary.safe, severity: "safe" as const },
  ];

  return (
    <div className="grid grid-cols-5 gap-2 mb-6">
      {stats.map(({ label, count, severity }) => {
        const style = SEVERITY_STYLES[severity];
        return (
          <div
            key={severity}
            className={`p-3 rounded-lg text-center ${style.bg} border ${style.border}`}
          >
            <div className={`text-2xl font-bold ${style.text}`}>{count}</div>
            <div className="text-xs text-muted-foreground">{label}</div>
          </div>
        );
      })}
    </div>
  );
}

interface VulnerabilityResultProps {
  result: VulnerabilityAnalysisResult;
}

/**
 * ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì»´í¬ë„ŒíŠ¸
 */
export function VulnerabilityResult({ result }: VulnerabilityResultProps) {
  // ì‹¬ê°ë„ ìˆœì„œë¡œ ì •ë ¬
  const sortedPackages = [...result.packages].sort((a, b) => {
    const order: SeverityWithSafe[] = ["critical", "high", "medium", "low", "safe"];
    return order.indexOf(a.maxSeverity) - order.indexOf(b.maxSeverity);
  });

  return (
    <Card>
      <CardHeader className="pb-3">
        <CardTitle className="text-lg flex items-center gap-2">
          ğŸ”’ ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼
          <span className="text-sm font-normal text-muted-foreground">
            ({result.totalVulnerabilities}ê°œ ë°œê²¬)
          </span>
        </CardTitle>
      </CardHeader>
      <CardContent>
        <SummaryStats result={result} />

        <div className="space-y-2">
          {sortedPackages.map((pkg) => (
            <PackageVulnerabilityCard
              key={`${pkg.packageName}@${pkg.version}`}
              pkg={pkg}
            />
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
